<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monolith â€” Structural English Visualizer</title>
<link rel="icon" href="/static/favicon.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #0a0a0a;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h1 {
    margin-top: 40px;
    font-size: 2rem;
    letter-spacing: 0.3em;
    color: #fff;
    text-transform: uppercase;
  }

  .subtitle {
    color: #666;
    font-size: 0.85rem;
    margin-top: 4px;
    letter-spacing: 0.1em;
  }

  .input-area {
    margin-top: 40px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 90%;
    max-width: 800px;
  }

  textarea {
    flex: 1;
    padding: 14px 20px;
    font-size: 1.05rem;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    outline: none;
    transition: border-color 0.3s;
    resize: vertical;
    min-height: 48px;
    max-height: 200px;
    font-family: inherit;
    line-height: 1.5;
  }

  textarea:focus { border-color: #666; }

  button {
    padding: 14px 28px;
    font-size: 1rem;
    background: #fff;
    color: #000;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    letter-spacing: 0.05em;
    transition: background 0.2s;
    align-self: flex-end;
  }

  button:hover { background: #ddd; }
  button:disabled { background: #444; color: #888; cursor: wait; }

  .result-area {
    margin-top: 48px;
    width: 90%;
    max-width: 800px;
    min-height: 100px;
  }

  .sentence-group {
    margin-bottom: 28px;
  }

  .original {
    color: #555;
    font-size: 0.85rem;
    margin-bottom: 10px;
    font-style: italic;
  }

  .blocks-wrap {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 2px;
  }

  /* Block rendering */
  .block {
    display: inline-flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 4px;
    padding: 6px 12px;
    margin: 3px;
    border-radius: 6px;
    border: 2px solid;
    position: relative;
    vertical-align: top;
  }

  .block-text {
    font-size: 1.2rem;
    font-weight: 500;
    line-height: 1.8;
  }

  /* Role icons â€” only visible in shift mode */
  .block::before {
    font-size: 0.7rem;
    margin-right: 4px;
    opacity: 0;
    transition: opacity 0.15s;
    display: inline;
  }
  .role-S::before  { content: '\f007'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .role-V::before  { content: '\f0e7'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .role-O::before  { content: '\f140'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .role-C::before  { content: '\f52c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .role-M::before  { content: '\f3c5'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .role-CONJ::before { content: '\f219'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .role-REL::before  { content: '\f0c1'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .role-SUB::before  { content: '\f466'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
  .shift-mode::before { opacity: 0.9; }

  /* Role colors â€” no labels, only colors speak */
  .role-S  { border-color: #4a9eff; background: rgba(74,158,255,0.08); }
  .role-V  { border-color: #ff6b6b; background: rgba(255,107,107,0.08); }
  .role-O  { border-color: #51cf66; background: rgba(81,207,102,0.08); }
  .role-C  { border-color: #ffd43b; background: rgba(255,212,59,0.08); }
  .role-M  { border-color: #b197fc; background: rgba(177,151,252,0.08); }
  .role-CONJ { border-color: #868e96; background: rgba(134,142,150,0.08); }
  .role-REL  { border-color: #ff922b; background: rgba(255,146,43,0.08); }
  .role-SUB  { border-color: #20c997; background: rgba(32,201,151,0.08); }

  .role-S .block-text  { color: #4a9eff; }
  .role-V .block-text  { color: #ff6b6b; }
  .role-O .block-text  { color: #51cf66; }
  .role-C .block-text  { color: #ffd43b; }
  .role-M .block-text  { color: #b197fc; }
  .role-CONJ .block-text { color: #868e96; }
  .role-REL .block-text  { color: #ff922b; }
  .role-SUB .block-text  { color: #20c997; }

  /* Nested blocks get slightly more padding and distinct background */
  .block .block { background: rgba(255,255,255,0.03); }
  .block .block .block { background: rgba(255,255,255,0.05); }

  /* Tooltip */
  .block { position: relative; cursor: default; }
  .block > .tooltip {
    display: none;
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    color: #111;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    white-space: nowrap;
    z-index: 100;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }
  .block > .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: #fff;
  }
  .block:hover > .tooltip { display: block; }
  .block.shift-mode > .tooltip { display: none; }

  /* Word-level tooltips */
  .word-span { position: relative; cursor: pointer; }
  .word-span .word-tip {
    display: none;
    position: absolute;
    bottom: calc(100% + 4px);
    left: 50%;
    transform: translateX(-50%);
    background: #ffe066;
    color: #111;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.8rem;
    white-space: nowrap;
    z-index: 101;
    pointer-events: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .word-span .word-tip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: #ffe066;
  }
  .shift-mode .word-span:hover .word-tip { display: block; }

  /* Clickable text blocks */
  .block-text { cursor: pointer; transition: opacity 0.15s; }
  .block-text:active { opacity: 0.6; }
  .block-text.speaking { text-decoration: underline; text-decoration-style: dotted; }

  /* Legend */
  .legend {
    margin-top: 48px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
    opacity: 0.6;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    position: relative;
    cursor: pointer;
  }

  .legend-item .legend-tip {
    display: none;
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    color: #111;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 0.78rem;
    line-height: 1.6;
    width: 270px;
    white-space: normal;
    z-index: 200;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    pointer-events: none;
  }
  .legend-item .legend-tip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #fff;
  }
  .legend-item:hover .legend-tip { display: block; }

  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
  }

  .leg-shift { display: none; }
  body.shift-active .leg-shift { display: inline; }
  body.shift-active .leg-normal { display: none; }

  .error { color: #ff6b6b; margin-top: 20px; }

  .loading {
    color: #666;
    font-size: 1.1rem;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
  }

  /* History */
  .history {
    margin-top: 60px;
    width: 90%;
    max-width: 800px;
    border-top: 1px solid #222;
    padding-top: 24px;
  }

  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
  }
  .level-selector {
    display: flex;
    gap: 4px;
  }
  .level-btn {
    padding: 8px 14px;
    border: 1px solid #333;
    background: #111;
    color: #888;
    cursor: pointer;
    font-size: 13px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .level-btn:hover {
    border-color: #555;
    color: #ccc;
  }
  .level-btn.active {
    background: #1a1a2e;
    border-color: #4a9eff;
    color: #4a9eff;
  }
  .textarea-wrap {
    position: relative;
    width: 100%;
  }
  .textarea-wrap textarea {
    width: 100%;
  }
  .clear-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    padding: 2px 10px;
    border: 1px solid #c7505066;
    background: #1a1a1a;
    color: #c75050;
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
    transition: all 0.2s;
    display: none;
  }
  .clear-btn:hover {
    border-color: #c75050;
    background: #c7505020;
  }
  .loading {
    display: flex;
    gap: 12px;
    justify-content: center;
    padding: 2rem;
  }
  .loading i {
    font-size: 1.2rem;
    color: #666;
    animation: bounce 1.2s ease-in-out infinite;
  }
  .loading i:nth-child(2) { animation-delay: 0.2s; }
  .loading i:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-12px); }
  }
  .source-text {
    font-size: 13px;
    color: #666;
    margin-bottom: 4px;
    font-style: italic;
  }
  .history-entry {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid #1a1a1a;
  }

  .separator {
    border: none;
    border-top: 1px solid #222;
    margin: 16px 0;
  }

  /* Chat Widget */
  .chat-widget {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 1000;
    animation: chat-float 3s ease-in-out infinite;
  }
  .chat-widget.open {
    animation: none;
  }
  .chat-widget.open .chat-toggle { display: none; }
  .chat-widget.open .chat-hint { display: none; }

  .chat-toggle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid #4a9eff;
    background: #0d0d1a;
    color: #4a9eff;
    font-size: 2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(74, 158, 255, 0.3);
  }
  @keyframes chat-float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }
  .chat-widget:hover {
    animation-play-state: paused;
  }
  .chat-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(74, 158, 255, 0.5);
  }
  .chat-toggle.has-parse {
    box-shadow: 0 4px 24px rgba(74, 158, 255, 0.5);
  }

  .chat-hint {
    position: absolute;
    bottom: 90px;
    right: 0;
    background: #151520;
    color: #ccc;
    padding: 0.6rem 1rem;
    border-radius: 16px;
    font-size: 0.85rem;
    font-weight: 500;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    border: 1px solid #4a9eff44;
    white-space: nowrap;
    cursor: pointer;
    pointer-events: auto;
  }
  .chat-hint::before {
    content: '';
    position: absolute;
    bottom: -10px;
    right: 27px;
    width: 0;
    height: 0;
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-top: 10px solid #4a9eff44;
  }
  .chat-hint::after {
    content: '';
    position: absolute;
    bottom: -7px;
    right: 28px;
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid #151520;
  }
  /* .chat-hint.show removed â€” always visible */

  .chat-panel {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 380px;
    max-height: 500px;
    background: #111;
    border: 1px solid #333;
    border-radius: 12px;
    display: none;
    flex-direction: column;
    z-index: 1000;
    overflow: hidden;
  }
  .chat-panel.open { display: flex; }

  .chat-header {
    padding: 12px 16px;
    background: #1a1a1a;
    border-bottom: 1px solid #222;
    font-size: 0.85rem;
    color: #888;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .chat-header span { color: #4a9eff; font-weight: 600; }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    max-height: 360px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .chat-row {
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }
  .chat-row.user { flex-direction: row-reverse; }
  .chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    border: 2px solid #333;
    background: #1a1a1a;
  }
  .chat-row.bot .chat-avatar {
    background: #1a1a2e;
    border-color: #4a9eff;
    color: #4a9eff;
  }
  .chat-row.user .chat-avatar {
    background: #1a1a1a;
    border-color: #555;
    color: #888;
  }
  .chat-bubble-wrap {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    line-height: 1.6;
    word-wrap: break-word;
  }
  .chat-row.bot .chat-bubble-wrap {
    background: #151515;
    border: 2px solid #222;
    border-radius: 20px 20px 20px 4px;
    color: #bbb;
  }
  .chat-row.bot .chat-bubble-wrap strong { color: #4a9eff; }
  .chat-row.user .chat-bubble-wrap {
    background: #1a1a2e;
    border: 2px solid #4a9eff44;
    border-radius: 20px 20px 4px 20px;
    color: #ccc;
  }

  .chat-input-area {
    display: flex;
    gap: 8px;
    padding: 10px 12px;
    border-top: 1px solid #222;
    background: #0e0e0e;
  }
  .chat-input-area input {
    flex: 1;
    padding: 8px 12px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    color: #fff;
    font-size: 0.85rem;
    outline: none;
  }
  .chat-input-area input:focus { border-color: #4a9eff; }
  .chat-input-area button {
    padding: 8px 16px;
    background: #1a1a2e;
    border: 1px solid #4a9eff;
    color: #4a9eff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .chat-input-area button:hover { background: #4a9eff22; }
</style>
</head>
<body>

<h1><i class="fa-solid fa-cube"></i> Monolith</h1>
<p class="subtitle">Structural English Visualizer</p>

<div class="input-area">
  <div class="textarea-wrap">
    <textarea id="sentence" placeholder="Enter any sentence... (English, æ—¥æœ¬èª, ä¸­æ–‡, etc.)" rows="2"></textarea>
    <button class="clear-btn" onclick="document.getElementById('sentence').value=''; this.style.display='none'; document.getElementById('sentence').focus();">Clear</button>
  </div>
  <div class="controls">
    <div class="level-selector">
      <button class="level-btn" data-level="beginner" title="Simple sentences, basic vocabulary">Beginner</button>
      <button class="level-btn active" data-level="intermediate" title="Natural expressions, moderate complexity">Intermediate</button>
      <button class="level-btn" data-level="advanced" title="Complex nesting, academic vocabulary">Advanced</button>
    </div>
    <button id="parseBtn" onclick="parse()">Parse</button>
  </div>
</div>

<div class="result-area" id="result"></div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#4a9eff"></div><span class="leg-normal">Subject</span><span class="leg-shift"><i class="fas fa-user"></i> èª°ãŒ</span><span class="legend-tip">Subjectï¼ˆä¸»èªï¼‰â€” æ–‡ã®ä¸»å½¹ã€‚ã€Œèª°ãŒã€ã€Œä½•ãŒã€å‹•ä½œã™ã‚‹ã®ã‹ã€‚è‹±èªã¯å¿…ãšã“ã“ã‹ã‚‰å§‹ã¾ã‚‹ã€‚</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#ff6b6b"></div><span class="leg-normal">Verb</span><span class="leg-shift"><i class="fas fa-bolt"></i> ã©ã†ã™ã‚‹</span><span class="legend-tip">Verbï¼ˆå‹•è©ï¼‰â€” æ–‡ã®å¿ƒè‡“ã€‚ä¸»èªãŒã€Œä½•ã‚’ã™ã‚‹ã€ã®ã‹ã€‚ã“ã‚ŒãŒãªã„ã¨æ–‡ã«ãªã‚‰ãªã„ã€‚</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#51cf66"></div><span class="leg-normal">Object</span><span class="leg-shift"><i class="fas fa-bullseye"></i> ä½•ã‚’</span><span class="legend-tip">Objectï¼ˆç›®çš„èªï¼‰â€” å‹•ä½œã®å—ã‘æ‰‹ã€‚ã€Œä½•ã‚’ã€ã€Œèª°ã‚’ã€ã€‚å‹•è©ã®åŠ›ãŒå‘ã‹ã†å…ˆã€‚</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#ffd43b"></div><span class="leg-normal">Complement</span><span class="leg-shift"><i class="fas fa-equals"></i> ï¼ä½•</span><span class="legend-tip">Complementï¼ˆè£œèªï¼‰â€” ã‚¤ã‚³ãƒ¼ãƒ«ã®é–¢ä¿‚ã€‚She is a doctor. ã®ã€Œa doctorã€ã®ã‚ˆã†ã«ã€ä¸»èªï¼ä½•ã‹ã‚’ç¤ºã™ã€‚</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#b197fc"></div><span class="leg-normal">Modifier</span><span class="leg-shift"><i class="fas fa-location-dot"></i> ã„ã¤ãƒ»ã©ã“</span><span class="legend-tip">Modifierï¼ˆä¿®é£¾èªå¥ï¼‰â€” è¿½åŠ æƒ…å ±ã€‚ã„ã¤ãƒ»ã©ã“ã§ãƒ»ã©ã†ã‚„ã£ã¦ã€‚ãªãã¦ã‚‚æ–‡ã¯æˆã‚Šç«‹ã¤ãŒã€æ„å‘³ãŒè±Šã‹ã«ãªã‚‹ã€‚</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#20c997"></div><span class="leg-normal">Clause</span><span class="leg-shift"><i class="fas fa-box"></i> æ–‡ã®ä¸­ã®æ–‡</span><span class="legend-tip">Subordinate Clauseï¼ˆå¾“å±ç¯€ï¼‰â€” ã€Œã€œã¨ã„ã†ã“ã¨ã€ã€Œã€œãªã®ã§ã€ã€‚æ–‡ã®ä¸­ã«ã‚‚ã†ä¸€ã¤ã®æ–‡ãŒå…¥ã‚‹å…¥ã‚Œå­æ§‹é€ ã€‚</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#ff922b"></div><span class="leg-normal">Relative</span><span class="leg-shift"><i class="fas fa-link"></i> èª¬æ˜ã™ã‚‹æ–‡</span><span class="legend-tip">Relative Clauseï¼ˆé–¢ä¿‚è©ç¯€ï¼‰â€” ã€Œã€œã™ã‚‹ã¨ã“ã‚ã®ã€ã€‚åè©ã‚’å¾Œã‚ã‹ã‚‰èª¬æ˜ã™ã‚‹æ–‡ã€‚è‹±èªãŒå‰ã‹ã‚‰å¾Œã‚ã«ä¼¸ã³ã‚‹æ„Ÿè¦šã®æ­£ä½“ã€‚</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#868e96"></div><span class="leg-normal">Conjunction</span><span class="leg-shift"><i class="fas fa-diamond"></i> ã¤ãªã</span><span class="legend-tip">Conjunctionï¼ˆæ¥ç¶šè©ï¼‰â€” ã¤ãªãè¨€è‘‰ã€‚that, which, because, and ãªã©ã€‚ãƒ–ãƒ­ãƒƒã‚¯ã¨ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¤ãªãæ¥ç€å‰¤ã€‚</span></div>
</div>

<div class="history" id="history"></div>

<!-- Chat Toggle Button -->
<div class="chat-widget" id="chatWidget">
  <button class="chat-toggle" id="chatToggle" title="Tutor ã«è³ªå•ã™ã‚‹">
    <i class="fa-solid fa-cube"></i>
  </button>
  <div class="chat-hint" id="chatBubble"><i class="fa-solid fa-cube"></i> TutorãŒãŠã“ãŸãˆã—ã¾ã™ã€‚</div>

  <!-- Chat Panel -->
  <div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <div><i class="fa-solid fa-cube" style="color:#4a9eff"></i> <span>Tutor</span></div>
    <button onclick="document.getElementById('chatToggle').click()" style="background:none;border:none;color:#666;cursor:pointer;font-size:1rem;padding:0"><i class="fas fa-xmark"></i></button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-area">
    <input type="text" id="chatInput" placeholder="ãªã‚“ã§ã“ã®æ§‹é€ ã«ãªã‚‹ã®ï¼Ÿ">
    <button onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>
</div><!-- /chat-widget -->

<script>
const apiBase = location.pathname.includes('/monolith') ? '/monolith' : '';
// Shift key tracking for word-level tooltips
let shiftHeld = false;
document.addEventListener('keydown', e => {
  if (e.key === 'Shift' && !shiftHeld) {
    shiftHeld = true;
    document.body.classList.add('shift-active');
    document.querySelectorAll('.block').forEach(b => b.classList.add('shift-mode'));
  }
});
document.addEventListener('keyup', e => {
  if (e.key === 'Shift') {
    shiftHeld = false;
    document.body.classList.remove('shift-active');
    document.querySelectorAll('.block').forEach(b => b.classList.remove('shift-mode'));
  }
});

// TTS via Web Speech API
function speak(text, el) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'en-US';
  utter.rate = 0.9;
  if (el) {
    el.classList.add('speaking');
    utter.onend = () => el.classList.remove('speaking');
  }
  window.speechSynthesis.speak(utter);
}

const input = document.getElementById('sentence');
const btn = document.getElementById('parseBtn');
const result = document.getElementById('result');
const historyEl = document.getElementById('history');
let currentLevel = 'intermediate';

document.querySelectorAll('.level-btn').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('.level-btn').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    currentLevel = b.dataset.level;
  });
});

const clearBtn = document.querySelector('.clear-btn');
input.addEventListener('input', () => {
  clearBtn.style.display = input.value.trim() ? 'block' : 'none';
});
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) { e.preventDefault(); parse(); }
});

function collectText(block) {
  if (block.text) return block.text;
  if (block.children) return block.children.map(collectText).join(' ');
  return '';
}

function renderBlock(block) {
  const el = document.createElement('span');
  el.className = `block role-${block.role || 'M'}`;

  // Click on block â†’ speak all text within
  el.addEventListener('click', (e) => {
    e.stopPropagation();
    const fullText = collectText(block);
    if (fullText) speak(fullText, el);
  });

  // Tooltip with Japanese translation
  if (block.ja) {
    const tip = document.createElement('span');
    tip.className = 'tooltip';
    tip.textContent = block.ja;
    el.appendChild(tip);
  }

  if (block.children && Array.isArray(block.children)) {
    block.children.forEach(child => el.appendChild(renderBlock(child)));
  } else if (block.text) {
    const txt = document.createElement('span');
    txt.className = 'block-text';
    if (block.words && Array.isArray(block.words)) {
      block.words.forEach((w, i) => {
        const ws = document.createElement('span');
        ws.className = 'word-span';
        ws.textContent = w.en;
        ws.addEventListener('click', (e) => {
          e.stopPropagation();
          if (shiftHeld) {
            speak(w.en, ws);
          } else {
            speak(block.text, txt);
          }
        });
        if (w.ja) {
          const wt = document.createElement('span');
          wt.className = 'word-tip';
          wt.textContent = w.ja;
          ws.appendChild(wt);
        }
        txt.appendChild(ws);
        if (i < block.words.length - 1) txt.appendChild(document.createTextNode(' '));
      });
    } else {
      txt.textContent = block.text;
      txt.addEventListener('click', (e) => { e.stopPropagation(); speak(block.text, txt); });
    }
    el.appendChild(txt);
  }
  return el;
}

function renderSentences(sentences, container) {
  sentences.forEach(s => {
    const group = document.createElement('div');
    group.className = 'sentence-group';

    if (s.source) {
      const src = document.createElement('div');
      src.className = 'source-text';
      src.textContent = 'ğŸ’¬ ' + s.source;
      group.appendChild(src);
    }
    if (s.text) {
      const orig = document.createElement('div');
      orig.className = 'original';
      orig.textContent = s.text;
      group.appendChild(orig);
    }

    const wrap = document.createElement('div');
    wrap.className = 'blocks-wrap';
    if (Array.isArray(s.blocks)) {
      s.blocks.forEach(b => wrap.appendChild(renderBlock(b)));
    }
    group.appendChild(wrap);
    container.appendChild(group);
  });
}

async function parse() {} // overridden by chat module below
// --- Chat tutor ---
let chatOpen = false;
let chatHistory = [];
let lastParseData = null;

const chatToggle = document.getElementById('chatToggle');
const chatPanel = document.getElementById('chatPanel');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');

const chatBubble = document.getElementById('chatBubble');
const chatWidget = document.getElementById('chatWidget');

let chatInited = false;
chatToggle.addEventListener('click', () => {
  chatOpen = !chatOpen;
  chatPanel.classList.toggle('open', chatOpen);
  chatWidget.classList.toggle('open', chatOpen);
  chatBubble.classList.remove('show');
  if (chatOpen) {
    if (!chatInited) {
      appendChatMsg('<i class="fa-solid fa-cube" style="color:#4a9eff"></i> TutorãŒè‹±èªã®æ§‹é€ ã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚ä½•ã§ã‚‚ãŠæ°—è»½ã«èã„ã¦ãã ã•ã„ã€‚', 'bot');
      chatInited = true;
    }
    chatInput.focus();
  }
});

chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.isComposing) sendChat();
});

function appendChatMsg(text, role) {
  const row = document.createElement('div');
  row.className = `chat-row ${role}`;
  const avatar = document.createElement('div');
  avatar.className = 'chat-avatar';
  avatar.innerHTML = role === 'bot' ? '<i class="fa-solid fa-cube"></i>' : '<i class="fas fa-user"></i>';
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble-wrap';
  bubble.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  row.appendChild(avatar);
  row.appendChild(bubble);
  chatMessages.appendChild(row);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendChat() {
  const msg = chatInput.value.trim();
  if (!msg) return;
  chatInput.value = '';
  appendChatMsg(msg, 'user');
  chatHistory.push({role: 'user', text: msg});

  const loading = document.createElement('div');
  loading.className = 'chat-row bot';
  loading.innerHTML = '<div class="chat-avatar"><i class="fa-solid fa-cube"></i></div><div class="chat-bubble-wrap"><i class="fa-solid fa-cube" style="animation:bounce 1.2s infinite"></i></div>';
  chatMessages.appendChild(loading);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    const res = await fetch(apiBase + '/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        message: msg,
        context: lastParseData ? JSON.stringify(lastParseData) : '',
        history: chatHistory.slice(0, -1)
      })
    });
    const data = await res.json();
    loading.remove();
    const reply = data.reply || data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    appendChatMsg(reply, 'bot');
    chatHistory.push({role: 'bot', text: reply});
  } catch(e) {
    loading.remove();
    appendChatMsg('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message, 'bot');
  }
}

// Hook into parse to capture context
const _origParse = parse;
parse = async function() {
  const sentence = input.value.trim();
  if (!sentence) return;

  btn.disabled = true;
  result.innerHTML = '<div class="loading"><i class="fa-solid fa-cube"></i> <i class="fa-solid fa-cube"></i> <i class="fa-solid fa-cube"></i></div>';

  try {
    const res = await fetch(apiBase + '/api/parse', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({sentence, level: currentLevel})
    });
    const data = await res.json();

    if (data.error) {
      result.innerHTML = `<div class="error">${data.error}</div>`;
      return;
    }

    lastParseData = data;
    chatToggle.classList.add('has-parse');
    if (!chatOpen) {
      chatBubble.classList.add('show');
      setTimeout(() => chatBubble.classList.remove('show'), 4000);
    }

    result.innerHTML = '';
    const sentences = data.sentences || [];
    renderSentences(sentences, result);
    input.focus();
  } catch(e) {
    result.innerHTML = `<div class="error">${e.message}</div>`;
  } finally {
    btn.disabled = false;
  }
};
</script>


</body>
</html>
